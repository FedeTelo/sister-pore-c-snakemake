[tox]
requires = tox-conda
skipsdist = true
envlist = {conda,dev}-{mylinux,osx}

[testenv]
platform =
    mylinux: linux
    osx: darwin
setenv =
    SNAKEMAKE_STD_PARAMS = --printshellcmds --use-conda --show-failed-logs --conda-cleanup-pkgs cache --conda-frontend mamba --snakefile=workflow/Snakefile --configfile={toxinidir}/config/config.yaml --directory={toxinidir} --config output_dir=results.{envname}
conda_env = environment.yml
allowlist_externals =
    /bin/rm
commands_pre=
    rm -rf {toxinidir}/results.{envname}
commands=
    snakemake test {env:SNAKEMAKE_STD_PARAMS} -j {env:PORE_C_SNAKEMAKE_THREADS:10}
    mylinux: snakemake methylation {env:SNAKEMAKE_STD_PARAMS} -j {env:PORE_C_SNAKEMAKE_THREADS:10}

[testenv:conda]
description="Test against bioconda version"

[testenv:dev]
commands_pre=
    {[testenv]commands_pre}
    pip install -e  --no-deps --no-build-isolation {toxinidir}/submodules/pore-c/
conda_spec =
    {toxinidir}/submodules/pore-c/requirements/conda-spec.txt
commands=
    snakemake test {env:SNAKEMAKE_STD_PARAMS} pore_c_version=dev -j {env:PORE_C_SNAKEMAKE_THREADS:10}
    mylinux: snakemake methylation {env:SNAKEMAKE_STD_PARAMS} pore_c_version=dev -j {env:PORE_C_SNAKEMAKE_THREADS:10}


